# Claude Security Review
#
# Automatically triggers a security-focused AI review when sensitive files change.
# This complements the general Gemini PR review with deep security analysis.
#
# Triggers on changes to:
# - Authentication/authorization code
# - API endpoints
# - Secret/credential handling
# - Environment configuration
# - Database queries
# - Cryptographic operations

name: Claude Security Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    paths:
      # Authentication & Authorization
      - '**/auth/**'
      - '**/authentication/**'
      - '**/authorization/**'
      - '**/login/**'
      - '**/session/**'
      - '**/jwt/**'
      - '**/oauth/**'
      - '**/saml/**'

      # API & Network
      - '**/api/**'
      - '**/routes/**'
      - '**/endpoints/**'
      - '**/controllers/**'
      - '**/middleware/**'

      # Secrets & Configuration
      - '**/.env*'
      - '**/secrets/**'
      - '**/credentials/**'
      - '**/config/**'
      - '**/settings/**'

      # Database
      - '**/db/**'
      - '**/database/**'
      - '**/migrations/**'
      - '**/models/**'
      - '**/queries/**'
      - '**/sql/**'

      # Security-related files
      - '**/security/**'
      - '**/crypto/**'
      - '**/encryption/**'
      - '**/password/**'
      - '**/hash/**'

      # CI/CD & Infrastructure
      - '.github/workflows/**'
      - '**/terraform/**'
      - '**/k8s/**'
      - '**/kubernetes/**'
      - '**/docker/**'
      - 'Dockerfile*'

  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write
  id-token: write  # Required for anthropics/claude-code-action OIDC

# Concurrency: One security review per PR
concurrency:
  group: claude-security-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  check-permissions:
    name: Check Permissions
    runs-on: ubuntu-latest
    # Skip bots and draft PRs
    if: |
      github.event.pull_request.draft == false &&
      !contains(github.actor, '[bot]')
    outputs:
      can-review: ${{ steps.check.outputs.can-review }}

    steps:
      - name: Check user permissions
        id: check
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -euo pipefail

          AUTHOR="${{ github.event.pull_request.user.login }}"
          REPO="${{ github.repository }}"

          PERMISSION=$(gh api repos/"$REPO"/collaborators/"$AUTHOR"/permission --jq '.permission' 2>/dev/null || echo "none")

          if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "write" ]]; then
            echo "::notice::User $AUTHOR has $PERMISSION access - proceeding with security review"
            echo "can-review=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::User $AUTHOR has insufficient permissions ($PERMISSION) - skipping security review"
            echo "can-review=false" >> $GITHUB_OUTPUT
          fi

  security-review:
    name: Claude Security Review
    runs-on: ubuntu-latest
    needs: check-permissions
    if: needs.check-permissions.outputs.can-review == 'true'

    steps:
      - name: Check for API key
        id: check-key
        run: |
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "::notice::ANTHROPIC_API_KEY not configured. Skipping security review."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        if: steps.check-key.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        if: steps.check-key.outputs.skip != 'true'
        id: changed
        run: |
          # Get list of changed files for context
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"

          CHANGED_FILES=$(git diff --name-only "$BASE...$HEAD" | head -50)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Security Review
        if: steps.check-key.outputs.skip != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            Perform a comprehensive security-focused review of this PR.

            ## Changed Files
            ${{ steps.changed.outputs.files }}

            ## Security Review Checklist

            ### 1. Authentication & Authorization
            - [ ] Are authentication mechanisms properly implemented?
            - [ ] Is authorization enforced on all protected routes?
            - [ ] Are JWTs/session tokens properly validated?
            - [ ] Is multi-factor authentication considered where appropriate?

            ### 2. Input Validation & Sanitization
            - [ ] Is all user input properly validated and sanitized?
            - [ ] Are there protections against SQL injection?
            - [ ] Are there protections against XSS (Cross-Site Scripting)?
            - [ ] Are there protections against command injection?
            - [ ] Is file upload handling secure?

            ### 3. Secrets & Credentials
            - [ ] Are there any hardcoded secrets, API keys, or passwords?
            - [ ] Are environment variables used properly for sensitive data?
            - [ ] Are secrets excluded from version control?
            - [ ] Are credentials rotated and managed securely?

            ### 4. Data Protection
            - [ ] Is sensitive data encrypted at rest and in transit?
            - [ ] Are proper cryptographic algorithms used?
            - [ ] Is PII (Personally Identifiable Information) handled properly?
            - [ ] Are error messages free of sensitive information?

            ### 5. API Security
            - [ ] Is rate limiting implemented?
            - [ ] Are CORS policies properly configured?
            - [ ] Is API versioning handled securely?
            - [ ] Are deprecated endpoints properly sunset?

            ### 6. Infrastructure Security
            - [ ] Are Docker images using minimal base images?
            - [ ] Are Kubernetes manifests following security best practices?
            - [ ] Are CI/CD pipelines secure (no secret exposure)?
            - [ ] Are dependencies up to date and vulnerability-free?

            ## Output Format

            Format your findings as:

            ## Security Review Summary

            **Risk Level:** [Critical | High | Medium | Low | None]

            ### Findings

            #### Critical (Must Fix)
            - [Finding 1]: [Description] - [File:Line]
            - ...

            #### High (Should Fix)
            - [Finding 1]: [Description] - [File:Line]
            - ...

            #### Medium (Consider Fixing)
            - [Finding 1]: [Description] - [File:Line]
            - ...

            #### Low (Informational)
            - [Finding 1]: [Description] - [File:Line]
            - ...

            ### Recommendations
            1. [Specific actionable recommendation]
            2. ...

            ### Good Practices Observed
            - [Positive observation]
            - ...

          claude_args: |
            --max-turns 30
            --model claude-opus-4-5-20251101

      - name: Post notification for critical findings
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['security-review-needed']
            });
