# Claude Code Configuration Sync
#
# This workflow pulls the latest Claude Code configuration from
# bigdegenenergy/ai-dev-toolkit on a daily schedule.
#
# SETUP:
# 1. Copy this file to your repo's .github/workflows/ directory
# 2. Add GH_TOKEN secret (Personal Access Token with 'repo' scope)
#    - Required for private repos
#    - Recommended for all repos: PRs created with GITHUB_TOKEN won't trigger CI
# 3. Push to enable the workflow
#
# The workflow will:
# - Run every day at 9:00 AM UTC
# - Sync .claude/, docs/, and tools/ directories from the source repo
# - Create a PR if changes are detected
#
# IMPORTANT - CI Workflows:
# PRs created using the default GITHUB_TOKEN do NOT trigger 'on: pull_request'
# workflows. To ensure CI runs on sync PRs, you must:
#   Option A: Add a GH_TOKEN secret (PAT with 'repo' scope) - RECOMMENDED
#   Option B: Manually close and reopen the PR to trigger CI
#   Option C: Push an empty commit to the PR branch
#
# SECURITY NOTE:
# This workflow syncs executable hooks and configuration from an external repo.
# Always review the generated PR before merging. When workflow sync is enabled,
# ALL workflows from the upstream repo will be synced (overwriting existing files).
# This enables daily updates across multiple downstream repos from one upstream.
#
# BRANCH PROTECTION (Recommended):
# Set up branch protection on your main branch to ensure sync PRs are reviewed:
#   1. Go to Settings > Branches > Add branch protection rule
#   2. Branch name pattern: main (or master)
#   3. Enable:
#      - âœ… Require a pull request before merging
#      - âœ… Require status checks to pass before merging
#        - Add required checks: CI, secrets-scan, gitleaks, pii-scan
#      - âœ… Require conversation resolution before merging
#      - âœ… Do not allow bypassing the above settings (optional)
#   4. Save changes
#
# This ensures automated sync PRs cannot be merged without review and passing CI.

name: Sync Claude Config

on:
  schedule:
    # Run every day at 9:00 AM UTC
    - cron: '0 9 * * *'

  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (owner/repo)'
        required: false
        default: 'bigdegenenergy/ai-dev-toolkit'
        type: string
      source_branch:
        description: 'Source branch to sync from'
        required: false
        default: 'main'
        type: string
      sync_github_workflows:
        description: 'Sync ALL .github/workflows from upstream (overwrites existing - review PR before merging)'
        required: false
        default: true
        type: boolean
      dry_run:
        description: 'Dry run - show changes without creating PR'
        required: false
        default: false
        type: boolean
      run_audit:
        description: 'Run Agent Readiness Audit and include results in PR'
        required: false
        default: true
        type: boolean

env:
  SOURCE_REPO: ${{ inputs.source_repo || 'bigdegenenergy/ai-dev-toolkit' }}
  SOURCE_BRANCH: ${{ inputs.source_branch || 'main' }}

jobs:
  sync:
    name: Sync Configuration
    runs-on: ubuntu-latest

    # Don't run on the source repo itself
    if: github.repository != 'bigdegenenergy/ai-dev-toolkit'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Set up Python (for Agent Readiness Audit)
        if: inputs.run_audit != false
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch source repo
        run: |
          echo "ðŸ“¥ Fetching latest from ${{ env.SOURCE_REPO }}..."

          # Clone source repo to temp directory
          git clone --depth 1 --branch ${{ env.SOURCE_BRANCH }} \
            https://github.com/${{ env.SOURCE_REPO }}.git /tmp/claude-code-source

          echo "âœ… Source repo fetched successfully"

      - name: Sync .claude directory
        id: sync_claude
        run: |
          echo "ðŸ”„ Syncing .claude/ directory..."

          # Create .claude directory if it doesn't exist
          mkdir -p .claude

          # Track if changes were made
          CHANGES_MADE=false

          # Sync .claude directory (excluding local config files)
          if [ -d "/tmp/claude-code-source/.claude" ]; then
            # Remove existing .claude contents (except local overrides)
            # Preserve: notifications.json, local-settings.json, artifacts/

            # Files to preserve (if they exist)
            PRESERVE_FILES=""
            [ -f ".claude/notifications.json" ] && cp .claude/notifications.json /tmp/notifications.json.bak && PRESERVE_FILES="$PRESERVE_FILES notifications.json"
            [ -f ".claude/local-settings.json" ] && cp .claude/local-settings.json /tmp/local-settings.json.bak && PRESERVE_FILES="$PRESERVE_FILES local-settings.json"
            [ -d ".claude/artifacts" ] && cp -r .claude/artifacts /tmp/artifacts.bak && PRESERVE_FILES="$PRESERVE_FILES artifacts/"

            # Copy new .claude contents
            rsync -av --delete \
              --exclude 'notifications.json' \
              --exclude 'local-settings.json' \
              --exclude 'artifacts/' \
              /tmp/claude-code-source/.claude/ .claude/

            # Restore preserved files
            [ -f "/tmp/notifications.json.bak" ] && mv /tmp/notifications.json.bak .claude/notifications.json
            [ -f "/tmp/local-settings.json.bak" ] && mv /tmp/local-settings.json.bak .claude/local-settings.json
            [ -d "/tmp/artifacts.bak" ] && mv /tmp/artifacts.bak .claude/artifacts

            echo "âœ… .claude/ directory synced"
            echo "   Preserved local files: $PRESERVE_FILES"

            # Check for changes
            if ! git diff --quiet .claude/; then
              CHANGES_MADE=true
            fi

            if ! git diff --quiet --cached .claude/; then
              CHANGES_MADE=true
            fi

            # Check for untracked files
            if [ -n "$(git ls-files --others --exclude-standard .claude/)" ]; then
              CHANGES_MADE=true
            fi
          else
            echo "âš ï¸ No .claude directory found in source repo"
          fi

          echo "changes_made=$CHANGES_MADE" >> $GITHUB_OUTPUT

      - name: Sync .github/workflows
        id: sync_workflows
        if: inputs.sync_github_workflows != false
        run: |
          echo "ðŸ”„ Syncing .github/workflows/ directory..."
          echo "   Syncing ALL workflows from upstream (overwriting existing files)"
          echo "   Review PR carefully before merging"
          echo ""

          CHANGES_MADE=false

          if [ -d "/tmp/claude-code-source/.github/workflows" ]; then
            mkdir -p .github/workflows
            mkdir -p .github/scripts
            mkdir -p .github/actions
            mkdir -p .github/ISSUE_TEMPLATE

            # Sync ALL workflow files from upstream (force overwrite)
            # This enables daily updates across multiple repos from one upstream
            echo "  Syncing all workflow files..."
            for workflow in /tmp/claude-code-source/.github/workflows/*.yml; do
              [ -f "$workflow" ] || continue
              workflow_name=$(basename "$workflow")
              cp "$workflow" ".github/workflows/$workflow_name"
              echo "    Synced: $workflow_name"
            done

            # Also sync .yaml files if any exist
            for workflow in /tmp/claude-code-source/.github/workflows/*.yaml; do
              [ -f "$workflow" ] || continue
              workflow_name=$(basename "$workflow")
              cp "$workflow" ".github/workflows/$workflow_name"
              echo "    Synced: $workflow_name"
            done

            # Sync scripts directory
            if [ -d "/tmp/claude-code-source/.github/scripts" ]; then
              cp -R /tmp/claude-code-source/.github/scripts/* .github/scripts/ 2>/dev/null || true
              echo "  Synced: scripts/"
            fi

            # Sync actions directory (composite actions like provenance-gate)
            if [ -d "/tmp/claude-code-source/.github/actions" ]; then
              mkdir -p .github/actions
              cp -R /tmp/claude-code-source/.github/actions/* .github/actions/ 2>/dev/null || true
              echo "  Synced: actions/"
            fi

            # Sync issue templates
            if [ -d "/tmp/claude-code-source/.github/ISSUE_TEMPLATE" ]; then
              cp -R /tmp/claude-code-source/.github/ISSUE_TEMPLATE/* .github/ISSUE_TEMPLATE/ 2>/dev/null || true
              echo "  Synced: ISSUE_TEMPLATE/"
            fi

            # Sync PR template
            if [ -f "/tmp/claude-code-source/.github/pull_request_template.md" ]; then
              cp /tmp/claude-code-source/.github/pull_request_template.md .github/
              echo "  Synced: pull_request_template.md"
            fi

            # Sync MCP config template
            if [ -f "/tmp/claude-code-source/.github/mcp-config.json.template" ]; then
              cp /tmp/claude-code-source/.github/mcp-config.json.template .github/
              echo "  Synced: mcp-config.json.template"
            fi

            echo "âœ… GitHub directory synced (all workflows)"

            # Check for changes
            if ! git diff --quiet .github/; then
              CHANGES_MADE=true
            fi
          fi

          echo "changes_made=$CHANGES_MADE" >> $GITHUB_OUTPUT

      - name: Sync root config files
        id: sync_root
        run: |
          echo "ðŸ”„ Syncing root configuration files..."

          CHANGES_MADE=false

          # NOTE: CLAUDE.md is NOT synced - each repo maintains its own project instructions

          # Sync .mcp.json.template if it exists in source
          if [ -f "/tmp/claude-code-source/.mcp.json.template" ]; then
            cp /tmp/claude-code-source/.mcp.json.template ./.mcp.json.template
            echo "  Synced: .mcp.json.template"
          fi

          # Check for changes
          if ! git diff --quiet .mcp.json.template 2>/dev/null; then
            CHANGES_MADE=true
          fi

          echo "changes_made=$CHANGES_MADE" >> $GITHUB_OUTPUT

      - name: Sync docs directory
        id: sync_docs
        run: |
          echo "ðŸ”„ Syncing docs/ directory..."

          CHANGES_MADE=false

          if [ -d "/tmp/claude-code-source/docs" ]; then
            mkdir -p docs

            # Copy documentation files (excluding generated content like onefilellm/)
            for doc in /tmp/claude-code-source/docs/*.md; do
              [ -f "$doc" ] || continue
              cp "$doc" "docs/$(basename "$doc")"
              echo "  Synced: docs/$(basename "$doc")"
            done

            # Check for changes
            if ! git diff --quiet docs/ 2>/dev/null; then
              CHANGES_MADE=true
            fi
          fi

          echo "changes_made=$CHANGES_MADE" >> $GITHUB_OUTPUT

      - name: Sync tools directory
        id: sync_tools
        run: |
          echo "ðŸ”„ Syncing tools/ directory..."

          CHANGES_MADE=false

          if [ -d "/tmp/claude-code-source/tools" ]; then
            mkdir -p tools

            # Copy tools directories
            for tool_dir in /tmp/claude-code-source/tools/*/; do
              [ -d "$tool_dir" ] || continue
              toolname=$(basename "$tool_dir")
              cp -R "$tool_dir" "tools/"
              echo "  Synced: tools/$toolname"
            done

            # Check for changes
            if ! git diff --quiet tools/ 2>/dev/null; then
              CHANGES_MADE=true
            fi
          fi

          echo "changes_made=$CHANGES_MADE" >> $GITHUB_OUTPUT

      - name: Run Agent Readiness Audit
        if: inputs.run_audit != false
        id: audit
        run: |
          echo "ðŸ” Running Agent Readiness Audit..."

          # Install the audit tool
          pip install --quiet agent-readiness-audit

          # Create output directory (within .claude/artifacts to be gitignored by default)
          mkdir -p .claude/artifacts/audit

          # Run audit and capture results
          set +e
          ara scan --repo . \
            --output-dir .claude/artifacts/audit \
            --format json \
            --format markdown 2>&1 | tee /tmp/audit-output.txt
          AUDIT_EXIT_CODE=$?
          set -e

          echo "audit_exit_code=$AUDIT_EXIT_CODE" >> $GITHUB_OUTPUT

          # Extract score from JSON if available
          if [ -f ".claude/artifacts/audit/report.json" ]; then
            SCORE=$(jq -r '.score // .total_score // "unknown"' .claude/artifacts/audit/report.json 2>/dev/null || echo "unknown")
            MATURITY=$(jq -r '.maturity_level // .maturity // "unknown"' .claude/artifacts/audit/report.json 2>/dev/null || echo "unknown")
            echo "score=$SCORE" >> $GITHUB_OUTPUT
            echo "maturity=$MATURITY" >> $GITHUB_OUTPUT
            echo "âœ… Audit complete: Score=$SCORE/16, Maturity=$MATURITY"
          else
            echo "score=unknown" >> $GITHUB_OUTPUT
            echo "maturity=unknown" >> $GITHUB_OUTPUT
            echo "âš ï¸ Could not parse audit results"
          fi

          # Rename markdown report for clarity
          if [ -f ".claude/artifacts/audit/report.md" ]; then
            mv .claude/artifacts/audit/report.md .claude/artifacts/audit/agent-readiness-report.md
          fi

          # Stage audit results
          git add -A .claude/artifacts/audit/ 2>/dev/null || true

      - name: Get source repo version
        id: version
        run: |
          cd /tmp/claude-code-source
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_DATE=$(git log -1 --format=%ci | cut -d' ' -f1)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Source version: $COMMIT_SHA ($COMMIT_DATE)"

      - name: Check for changes
        id: changes
        run: |
          # Stage all changes
          git add -A

          # Check if there are any staged changes
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“­ No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¬ Changes detected:"
            git diff --cached --stat
          fi

      - name: Show changes (dry run)
        if: inputs.dry_run == true && steps.changes.outputs.has_changes == 'true'
        run: |
          echo "ðŸ” DRY RUN - Changes that would be applied:"
          echo ""
          git diff --cached --stat
          echo ""
          echo "Detailed diff:"
          git diff --cached

      - name: Create sync branch
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry_run != true
        id: branch
        run: |
          BRANCH_NAME="claude-config-sync/${{ steps.version.outputs.commit_date }}-${{ steps.version.outputs.commit_sha }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Create and checkout branch
          git checkout -b "$BRANCH_NAME"

          # Commit changes
          git commit -m "chore: sync Claude Code config from ${{ env.SOURCE_REPO }}@${{ steps.version.outputs.commit_sha }}"

          echo "âœ… Created branch: $BRANCH_NAME"

      - name: Push branch
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry_run != true
        run: |
          git push -u origin "${{ steps.branch.outputs.branch_name }}"
          echo "âœ… Pushed branch to origin"

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry_run != true
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          SOURCE_REPO: ${{ env.SOURCE_REPO }}
          COMMIT_SHA: ${{ steps.version.outputs.commit_sha }}
          COMMIT_DATE: ${{ steps.version.outputs.commit_date }}
          SYNC_WORKFLOWS: ${{ inputs.sync_github_workflows }}
          AUDIT_SCORE: ${{ steps.audit.outputs.score }}
          AUDIT_MATURITY: ${{ steps.audit.outputs.maturity }}
        run: |
          # Build PR body
          WORKFLOW_LINE=""
          if [ "$SYNC_WORKFLOWS" == "true" ]; then
            WORKFLOW_LINE="- \`.github/workflows/\` (ALL workflows synced from upstream)
          - \`.github/actions/\` (composite actions: provenance-gate)"
          fi

          # Build audit section if audit was run
          AUDIT_SECTION=""
          if [ -n "$AUDIT_SCORE" ] && [ "$AUDIT_SCORE" != "" ]; then
            AUDIT_SECTION="
          ### ðŸ” Agent Readiness Audit

          | Metric | Value |
          |--------|-------|
          | **Score** | ${AUDIT_SCORE}/16 |
          | **Maturity Level** | ${AUDIT_MATURITY} |

          The [Agent Readiness Audit](https://github.com/bigdegenenergy/agent-readiness-audit) evaluates repository maturity for AI agent tooling across 15 pillars including reproducible builds, test infrastructure, type safety, documentation, and security practices.

          Full report: \`.claude/artifacts/audit/agent-readiness-report.md\`
          "
          fi

          PR_BODY="## ðŸ”„ Claude Code Configuration Sync

          This PR syncs the latest Claude Code configuration from the upstream repository.

          ### Source
          - **Repository:** [${SOURCE_REPO}](https://github.com/${SOURCE_REPO})
          - **Commit:** \`${COMMIT_SHA}\`
          - **Date:** ${COMMIT_DATE}

          ### Changes Synced
          - \`.claude/\` directory (commands, hooks, agents, skills)
          - \`.mcp.json.template\` (MCP server configuration)
          - \`docs/\` directory (setup guides and references)
          - \`tools/\` directory (utilities like onefilellm)
          ${WORKFLOW_LINE}

          **Note:** \`CLAUDE.md\` is NOT synced - each repo maintains its own project instructions.
          ${AUDIT_SECTION}
          ### âš ï¸ CI Note
          If this PR was created using the default GITHUB_TOKEN, CI workflows
          may not have triggered automatically. To run CI:
          - Close and reopen this PR, OR
          - Push an empty commit: \`git commit --allow-empty -m \"trigger ci\"\`

          ### Review Checklist
          - [ ] Review changes for compatibility with this project
          - [ ] Check for any project-specific customizations that may have been overwritten
          - [ ] Verify hooks and commands work correctly
          - [ ] Run tests to ensure nothing is broken
          ${AUDIT_SECTION:+- [ ] Review agent readiness audit findings}

          ### Local Files Preserved
          The following local files were **not** overwritten:
          - \`.claude/notifications.json\` (notification settings)
          - \`.claude/local-settings.json\` (local overrides)
          - \`.claude/artifacts/\` (generated artifacts)

          ---
          *This PR was automatically created by the [sync-claude-config](.github/workflows/sync-claude-config.yml) workflow.*"

          # Ensure labels exist before creating PR (--force updates if exists, creates if not)
          gh label create "automated" --description "Automated PR" --color "0E8A16" --force 2>/dev/null || true
          gh label create "claude-code" --description "Claude Code configuration" --color "7057FF" --force 2>/dev/null || true

          # Create PR with labels
          if gh pr create \
            --title "chore: sync Claude Code config (${COMMIT_DATE})" \
            --body "$PR_BODY" \
            --label "automated,claude-code" \
            --head "${{ steps.branch.outputs.branch_name }}"; then
            echo "âœ… Pull request created"
          else
            echo "âš ï¸ PR creation failed - may already exist"
            # Check if PR already exists for this branch
            EXISTING_PR=$(gh pr list --head "${{ steps.branch.outputs.branch_name }}" --json url --jq '.[0].url' 2>/dev/null || true)
            if [ -n "$EXISTING_PR" ]; then
              echo "ðŸ“‹ Existing PR: $EXISTING_PR"
            fi
          fi

      - name: Summary
        run: |
          echo "## ðŸ“Š Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Source Repo | \`${{ env.SOURCE_REPO }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Source Commit | \`${{ steps.version.outputs.commit_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Changes Detected | ${{ steps.changes.outputs.has_changes }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ inputs.dry_run || 'false' }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ] && [ "${{ inputs.dry_run }}" != "true" ]; then
            echo "| Branch Created | \`${{ steps.branch.outputs.branch_name }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| PR Created | âœ… |" >> $GITHUB_STEP_SUMMARY
          fi

          # Add audit results to summary if available
          if [ -n "${{ steps.audit.outputs.score }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ” Agent Readiness Audit" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Score | ${{ steps.audit.outputs.score }}/16 |" >> $GITHUB_STEP_SUMMARY
            echo "| Maturity Level | ${{ steps.audit.outputs.maturity }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[About Agent Readiness Audit](https://github.com/bigdegenenergy/agent-readiness-audit)" >> $GITHUB_STEP_SUMMARY
          fi
