# =============================================================================
# Open Cloud Ops - CI Pipeline
# =============================================================================
# Builds, lints, tests, and scans all three application modules.
# Triggered on pushes and pull requests to main and feature branches.
# =============================================================================

name: OCO CI

on:
  push:
    branches:
      - main
      - "feature/**"
      - "feat/**"
      - "fix/**"
  pull_request:
    branches:
      - main

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: "1.21"
  PYTHON_VERSION: "3.12"

jobs:
  # ---------------------------------------------------------------------------
  # Cerebra (Go) - Lint, Test, Build
  # ---------------------------------------------------------------------------
  cerebra-build:
    name: Cerebra (Go)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cerebra
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: cerebra/go.sum

      - name: Download dependencies
        run: go mod download

      - name: Lint with golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: cerebra
          args: --timeout=5m

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Build binary
        run: CGO_ENABLED=0 go build -o cerebra ./cmd/main.go

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: cerebra-coverage
          path: cerebra/coverage.out
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Economist (Python) - Lint, Type Check, Test
  # ---------------------------------------------------------------------------
  economist-build:
    name: Economist (Python)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: economist
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: economist/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff mypy pytest pytest-cov pytest-asyncio

      - name: Lint with ruff
        run: ruff check .

      - name: Type check with mypy
        run: mypy --ignore-missing-imports .
        continue-on-error: true

      - name: Run tests
        run: pytest -v --cov=. --cov-report=xml:coverage.xml || true

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: economist-coverage
          path: economist/coverage.xml
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Aegis (Go) - Lint, Test, Build
  # ---------------------------------------------------------------------------
  aegis-build:
    name: Aegis (Go)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: aegis
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: aegis/go.sum

      - name: Download dependencies
        run: go mod download

      - name: Lint with golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: aegis
          args: --timeout=5m

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Build binary
        run: CGO_ENABLED=0 go build -o aegis ./cmd/main.go

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: aegis-coverage
          path: aegis/coverage.out
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Docker Build - Build all images
  # ---------------------------------------------------------------------------
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [cerebra-build, economist-build, aegis-build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Cerebra image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deploy/docker/Dockerfile.cerebra
          push: false
          tags: open-cloud-ops/cerebra:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Economist image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deploy/docker/Dockerfile.economist
          push: false
          tags: open-cloud-ops/economist:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Aegis image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deploy/docker/Dockerfile.aegis
          push: false
          tags: open-cloud-ops/aegis:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # Security Scan - Trivy vulnerability scanning
  # ---------------------------------------------------------------------------
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [docker-build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Cerebra image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deploy/docker/Dockerfile.cerebra
          push: false
          load: true
          tags: open-cloud-ops/cerebra:scan

      - name: Build Economist image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deploy/docker/Dockerfile.economist
          push: false
          load: true
          tags: open-cloud-ops/economist:scan

      - name: Build Aegis image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deploy/docker/Dockerfile.aegis
          push: false
          load: true
          tags: open-cloud-ops/aegis:scan

      - name: Run Trivy on Cerebra
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: open-cloud-ops/cerebra:scan
          format: table
          exit-code: "1"
          severity: CRITICAL,HIGH
        continue-on-error: true

      - name: Run Trivy on Economist
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: open-cloud-ops/economist:scan
          format: table
          exit-code: "1"
          severity: CRITICAL,HIGH
        continue-on-error: true

      - name: Run Trivy on Aegis
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: open-cloud-ops/aegis:scan
          format: table
          exit-code: "1"
          severity: CRITICAL,HIGH
        continue-on-error: true
