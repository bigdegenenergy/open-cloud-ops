name: Notify on Failure

on:
  workflow_run:
    workflows: ["CI", "Security Scan"]
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    steps:
      - name: Send Slack Notification
        continue-on-error: true
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [{
                "color": "#FF0000",
                "title": "Workflow Failed: ${{ github.event.workflow_run.name }}",
                "text": "Repository: ${{ github.repository }}\nBranch: ${{ github.event.workflow_run.head_branch }}",
                "footer": "Claude Code CI"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Send Telegram Notification
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          REPO_NAME: ${{ github.repository }}
          BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            python3 -c "
          import os, json, urllib.request
          bot = os.environ['TELEGRAM_BOT_TOKEN']
          chat = os.environ['TELEGRAM_CHAT_ID']
          text = f\"ðŸ”´ *Workflow Failed*\n\n*Workflow:* {os.environ['WORKFLOW_NAME']}\n*Repository:* {os.environ['REPO_NAME']}\n*Branch:* {os.environ['BRANCH_NAME']}\n\n[View Run]({os.environ['RUN_URL']})\"
          payload = json.dumps({'chat_id': chat, 'text': text, 'parse_mode': 'Markdown'}).encode()
          req = urllib.request.Request(f'https://api.telegram.org/bot{bot}/sendMessage', data=payload, headers={'Content-Type': 'application/json'})
          urllib.request.urlopen(req)
          "
          fi

      - name: Send Discord Notification
        continue-on-error: true
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          REPO_NAME: ${{ github.repository }}
          BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            python3 -c "
          import os, json, urllib.request
          payload = json.dumps({'embeds': [{'title': f\"Workflow Failed: {os.environ['WORKFLOW_NAME']}\", 'description': f\"Repository: {os.environ['REPO_NAME']}\nBranch: {os.environ['BRANCH_NAME']}\", 'color': 16711680, 'url': os.environ['RUN_URL']}]}).encode()
          req = urllib.request.Request(os.environ['DISCORD_WEBHOOK_URL'], data=payload, headers={'Content-Type': 'application/json'})
          urllib.request.urlopen(req)
          "
          fi

      - name: Send ntfy Notification
        continue-on-error: true
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          NTFY_SERVER: ${{ secrets.NTFY_SERVER }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          REPO_NAME: ${{ github.repository }}
          BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
        run: |
          if [ -n "$NTFY_TOPIC" ]; then
            SERVER="${NTFY_SERVER:-https://ntfy.sh}"
            python3 -c "
          import os, urllib.request
          server = os.environ.get('NTFY_SERVER', 'https://ntfy.sh')
          topic = os.environ['NTFY_TOPIC']
          body = f\"Repository: {os.environ['REPO_NAME']} | Branch: {os.environ['BRANCH_NAME']}\".encode()
          req = urllib.request.Request(f'{server}/{topic}', data=body)
          req.add_header('Title', f\"Workflow Failed: {os.environ['WORKFLOW_NAME']}\")
          req.add_header('Priority', '5')
          req.add_header('Tags', 'x')
          req.add_header('Click', os.environ['RUN_URL'])
          urllib.request.urlopen(req)
          "
          fi

      - name: Send Custom Webhook
        continue-on-error: true
        env:
          CUSTOM_WEBHOOK_URL: ${{ secrets.CUSTOM_WEBHOOK_URL }}
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          REPO_NAME: ${{ github.repository }}
          BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
        run: |
          if [ -n "$CUSTOM_WEBHOOK_URL" ]; then
            python3 -c "
          import os, json, urllib.request
          payload = json.dumps({'event': 'workflow_failed', 'workflow': os.environ['WORKFLOW_NAME'], 'repository': os.environ['REPO_NAME'], 'branch': os.environ['BRANCH_NAME'], 'url': os.environ['RUN_URL']}).encode()
          req = urllib.request.Request(os.environ['CUSTOM_WEBHOOK_URL'], data=payload, headers={'Content-Type': 'application/json'})
          urllib.request.urlopen(req)
          "
          fi

      - name: Notification Complete
        run: echo "Notification job completed"
